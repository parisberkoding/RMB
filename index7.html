<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Geothermal AR - Edukasi Energi Panas Bumi</title>
    
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- AR.js -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    
    <!-- Scene Configuration -->
    <script src="js/scene-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            overflow: hidden !important;
            position: fixed !important;
            background: #000;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }

        /* ðŸ”§ FIX: Force AR Scene to be FULL SCREEN */
        #ar-scene {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            padding: 0 !important;
            z-index: 1 !important;
        }

        /* ðŸ”§ FIX: Force video and canvas to cover entire screen */
        #ar-scene canvas,
        #ar-scene video {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            object-fit: cover !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Remove any A-Frame default styles that might interfere */
        .a-canvas {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
        }

        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        #ui-overlay > * {
            pointer-events: auto;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader-content {
            text-align: center;
            color: white;
        }

        .loader-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: #00d9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loader-content h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .loader-content p {
            font-size: 14px;
            opacity: 0.7;
        }

        #scanner-instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            padding: 24px;
            background: rgba(0, 0, 0, 0.75);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            max-width: 320px;
            width: 90%;
            display: none;
        }

        #scanner-instructions.visible {
            display: block;
        }

        .scanner-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            border: 3px solid #00d9ff;
            border-radius: 12px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        #scanner-instructions h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        #scanner-instructions p {
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.4;
        }

        #start-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }

        #start-button.visible {
            display: block;
        }

        .btn-start {
            background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
            color: white;
            border: none;
            padding: 18px 48px;
            font-size: 18px;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0, 217, 255, 0.4);
        }

        #scene-card {
            position: fixed;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: rgba(26, 26, 46, 0.95);
            border-radius: 20px;
            padding: 20px;
            color: white;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        #scene-card.visible {
            display: block;
        }

        .scene-progress {
            font-size: 12px;
            color: #00d9ff;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .scene-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .scene-subtitle {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 12px;
        }

        .scene-description {
            font-size: 14px;
            line-height: 1.6;
            opacity: 0.9;
        }

        #nav-controls {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 12px;
        }

        #nav-controls.visible {
            display: flex;
        }

        .btn-nav {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .btn-nav.btn-next {
            background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
            border-color: transparent;
        }

        .btn-nav:disabled {
            opacity: 0.4;
        }

        #status-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        #status-bar.visible {
            display: flex;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
        }

        .status-indicator.active {
            background: #00ff88;
        }

        .status-text {
            color: white;
            font-size: 13px;
            font-weight: 500;
        }

        #audio-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(0, 217, 255, 0.2);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
        }

        #audio-indicator.visible {
            display: flex;
        }

        .audio-wave {
            width: 4px;
            height: 16px;
            background: #00d9ff;
            margin: 0 2px;
            border-radius: 2px;
            animation: wave 0.8s ease-in-out infinite;
        }

        .audio-wave:nth-child(2) { animation-delay: 0.1s; }
        .audio-wave:nth-child(3) { animation-delay: 0.2s; }

        @keyframes wave {
            0%, 100% { height: 16px; }
            50% { height: 8px; }
        }
    </style>
</head>
<body>
    <!-- AR Scene with Full Screen Fix -->
    <a-scene
        id="ar-scene"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; trackingMethod: best;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium; antialias: true; alpha: true;"
        loading-screen="enabled: false"
        device-orientation-permission-ui="enabled: false">
        
        <a-camera gps-camera rotation-reader look-controls-enabled="false"></a-camera>
        
        <!-- Marker Hiro -->
        <a-marker
            id="main-marker"
            preset="hiro"
            raycaster="objects: .clickable"
            emitevents="true"
            cursor="fuse: false; rayOrigin: mouse;">
            
            <!-- Model container dengan scale yang lebih kecil -->
            <a-entity id="model-container" position="0 0 0">
                <!-- Main geothermal plant -->
                <a-entity
                    id="full-plant-model"
                    gltf-model="assets/FullVersion.glb"
                    position="0 -0.3 0"
                    rotation="-90 0 0"
                    scale="0.5 0.5 0.5"
                    visible="true">
                </a-entity>
                
                <!-- Animated turbine fan -->
                <a-entity
                    id="turbine-fan-model"
                    gltf-model="assets/Turbine_Fan.glb"
                    position="0 -0.2 0"
                    rotation="-90 0 0"
                    scale="0.5 0.5 0.5"
                    visible="false">
                </a-entity>
            </a-entity>
        </a-marker>
    </a-scene>

    <!-- UI Overlay -->
    <div id="ui-overlay">
        <div id="loading-screen">
            <div class="loader-content">
                <div class="loader-icon"></div>
                <h2>Geothermal AR</h2>
                <p>Memuat pengalaman AR...</p>
            </div>
        </div>

        <div id="scanner-instructions">
            <div class="scanner-icon"></div>
            <h3>Scan Marker</h3>
            <p>Arahkan kamera ke marker Hiro untuk memulai</p>
        </div>

        <div id="start-button">
            <button class="btn-start" onclick="ARController.startSimulation()">
                Mulai Simulasi
            </button>
        </div>

        <div id="status-bar">
            <div class="status-indicator" id="marker-status"></div>
            <span class="status-text" id="marker-text">Mencari marker...</span>
        </div>

        <div id="scene-card">
            <div class="scene-progress" id="scene-progress">SCENE 1 / 5</div>
            <h2 class="scene-title" id="scene-title">Welcome</h2>
            <p class="scene-subtitle" id="scene-subtitle">Energi Bersih dari Perut Bumi</p>
            <p class="scene-description" id="scene-description">
                Selamat datang di Geothermal AR!
            </p>
        </div>

        <div id="nav-controls">
            <button class="btn-nav btn-prev" onclick="ARController.previousScene()">
                Sebelumnya
            </button>
            <button class="btn-nav btn-next" onclick="ARController.nextScene()">
                Selanjutnya
            </button>
        </div>

        <div id="audio-indicator">
            <div class="audio-wave"></div>
            <div class="audio-wave"></div>
            <div class="audio-wave"></div>
        </div>
    </div>

    <script>
        const ARController = {
            state: {
                currentSceneIndex: 0,
                isMarkerVisible: false,
                isSimulationStarted: false,
                audioPlaying: false,
                totalScenes: 0,
                modelsLoaded: false,
                userInteracted: false
            },

            elements: {},
            currentAudio: null,

            init() {
                console.log('ðŸš€ Initializing AR Controller...');
                
                if (!window.SCENE_CONFIG || !Array.isArray(window.SCENE_CONFIG) || window.SCENE_CONFIG.length === 0) {
                    console.error('âŒ SCENE_CONFIG error!');
                    alert('Configuration error! Check scene-config.js');
                    return;
                }
                
                this.cacheElements();
                
                if (!this.elements.marker) {
                    console.error('âŒ Required elements not found!');
                    return;
                }
                
                this.state.totalScenes = window.SCENE_CONFIG.length;
                console.log(`âœ… Loaded ${this.state.totalScenes} scenes`);
                
                this.setupMarkerListeners();
                this.setupModelLoadListeners();
                this.forceFullScreen();
                
                setTimeout(() => {
                    this.hideLoading();
                    this.showScannerInstructions();
                    this.forceFullScreen();
                }, 2000);
                
                // Force fullscreen on resize
                window.addEventListener('resize', () => this.forceFullScreen());
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.forceFullScreen(), 300);
                });
            },

            cacheElements() {
                this.elements = {
                    loadingScreen: document.getElementById('loading-screen'),
                    scannerInstructions: document.getElementById('scanner-instructions'),
                    startButton: document.getElementById('start-button'),
                    sceneCard: document.getElementById('scene-card'),
                    navControls: document.getElementById('nav-controls'),
                    statusBar: document.getElementById('status-bar'),
                    audioIndicator: document.getElementById('audio-indicator'),
                    sceneProgress: document.getElementById('scene-progress'),
                    sceneTitle: document.getElementById('scene-title'),
                    sceneSubtitle: document.getElementById('scene-subtitle'),
                    sceneDescription: document.getElementById('scene-description'),
                    markerStatus: document.getElementById('marker-status'),
                    markerText: document.getElementById('marker-text'),
                    marker: document.getElementById('main-marker'),
                    fullPlantModel: document.getElementById('full-plant-model'),
                    turbineFanModel: document.getElementById('turbine-fan-model'),
                    btnPrev: document.querySelector('.btn-prev'),
                    btnNext: document.querySelector('.btn-next'),
                    scene: document.getElementById('ar-scene')
                };
            },

            // ðŸ”§ FIX: Force camera to be full screen
            forceFullScreen() {
                try {
                    const width = window.innerWidth;
                    const height = window.innerHeight;
                    
                    // Get all video and canvas elements
                    const videos = document.querySelectorAll('video');
                    const canvases = document.querySelectorAll('canvas');
                    
                    videos.forEach(video => {
                        video.style.cssText = `
                            position: fixed !important;
                            top: 0 !important;
                            left: 0 !important;
                            width: ${width}px !important;
                            height: ${height}px !important;
                            object-fit: cover !important;
                            margin: 0 !important;
                            padding: 0 !important;
                        `;
                    });
                    
                    canvases.forEach(canvas => {
                        canvas.style.cssText = `
                            position: fixed !important;
                            top: 0 !important;
                            left: 0 !important;
                            width: ${width}px !important;
                            height: ${height}px !important;
                            margin: 0 !important;
                            padding: 0 !important;
                        `;
                        canvas.width = width;
                        canvas.height = height;
                    });
                    
                    console.log('ðŸ“ Forced full screen:', width, 'x', height);
                } catch (error) {
                    console.warn('Fullscreen error:', error);
                }
            },

            setupModelLoadListeners() {
                this.elements.fullPlantModel.addEventListener('model-loaded', () => {
                    console.log('âœ… Full plant model loaded');
                    this.state.modelsLoaded = true;
                });
                
                this.elements.turbineFanModel.addEventListener('model-loaded', () => {
                    console.log('âœ… Turbine fan model loaded');
                });
            },

            setupMarkerListeners() {
                const marker = this.elements.marker;
                
                if (!marker) {
                    console.error('âŒ Marker element not found!');
                    return;
                }
                
                marker.addEventListener('markerFound', () => {
                    console.log('âœ… Marker found!');
                    this.onMarkerFound();
                });
                
                marker.addEventListener('markerLost', () => {
                    console.log('âŒ Marker lost!');
                    this.onMarkerLost();
                });
            },

            onMarkerFound() {
                this.state.isMarkerVisible = true;
                
                this.elements.markerStatus.classList.add('active');
                this.elements.markerText.textContent = 'Marker terdeteksi';
                this.elements.statusBar.classList.add('visible');
                
                this.elements.scannerInstructions.classList.remove('visible');
                
                if (!this.state.isSimulationStarted) {
                    this.elements.startButton.classList.add('visible');
                } else {
                    this.showCurrentSceneModels();
                    
                    // ðŸ”§ FIX: Auto-play audio saat marker terdeteksi
                    if (this.currentAudio && this.state.userInteracted) {
                        this.currentAudio.play().catch(e => console.warn('Auto-play blocked:', e));
                    }
                }
            },

            onMarkerLost() {
                this.state.isMarkerVisible = false;
                
                this.elements.markerStatus.classList.remove('active');
                this.elements.markerText.textContent = 'Mencari marker...';
                
                if (!this.state.isSimulationStarted) {
                    this.elements.startButton.classList.remove('visible');
                    this.elements.scannerInstructions.classList.add('visible');
                }
                
                // Pause audio saat marker hilang
                if (this.currentAudio) {
                    this.currentAudio.pause();
                }
            },

            startSimulation() {
                if (!this.state.isMarkerVisible) {
                    alert('Marker belum terdeteksi! Arahkan kamera ke marker Hiro terlebih dahulu.');
                    return;
                }
                
                console.log('ðŸŽ¬ Starting simulation...');
                
                // Mark user interaction for audio autoplay
                this.state.userInteracted = true;
                this.state.isSimulationStarted = true;
                
                this.elements.startButton.classList.remove('visible');
                this.elements.sceneCard.classList.add('visible');
                this.elements.navControls.classList.add('visible');
                
                this.loadScene(0);
            },

            loadScene(sceneIndex) {
                if (sceneIndex < 0 || sceneIndex >= this.state.totalScenes) {
                    console.warn('âš ï¸ Invalid scene index:', sceneIndex);
                    return;
                }
                
                console.log(`ðŸŽ¬ Loading scene ${sceneIndex + 1}...`);
                
                this.stopAudio();
                
                this.state.currentSceneIndex = sceneIndex;
                const scene = window.SCENE_CONFIG[sceneIndex];
                
                this.updateSceneUI(scene);
                this.updateModels(scene);
                
                if (scene.camera) {
                    this.updateCamera(scene.camera);
                }
                
                // ðŸ”§ FIX: Auto-play audio dengan proper handling
                this.playAudio(scene.audio);
                this.updateNavButtons();
            },

            updateSceneUI(scene) {
                this.elements.sceneProgress.textContent = 
                    `SCENE ${this.state.currentSceneIndex + 1} / ${this.state.totalScenes}`;
                this.elements.sceneTitle.textContent = scene.title;
                this.elements.sceneSubtitle.textContent = scene.subtitle;
                
                const description = scene.description || this.generateSceneDescription(scene);
                this.elements.sceneDescription.textContent = description;
            },

            generateSceneDescription(scene) {
                const descriptions = {
                    1: "Selamat datang di Geothermal AR! Energi panas bumi adalah sumber energi terbarukan yang dihasilkan dari panas alami bumi. Mari kita jelajahi bagaimana energi ini dimanfaatkan untuk menghasilkan listrik ramah lingkungan.",
                    2: "Di kedalaman bumi terdapat lapisan-lapisan dengan suhu sangat tinggi. Kerak bumi, mantel, dan inti bumi menghasilkan panas luar biasa. Suhu inti bumi mencapai 5000Â°C - lebih panas dari permukaan matahari!",
                    3: "Uap panas bumi bertekanan tinggi menggerakkan bilah turbin dengan kecepatan tinggi. Putaran turbin menggerakkan generator yang mengubah energi kinetik menjadi energi listrik. Satu turbin dapat menghasilkan hingga 100 megawatt listrik!",
                    4: "Setelah melewati turbin, uap panas perlu didinginkan agar dapat digunakan kembali. Cooling tower menggunakan udara alami untuk mengondensasi uap menjadi air. Sistem ini memastikan tidak ada limbah dan menciptakan siklus tertutup yang ramah lingkungan.",
                    5: "Pembangkit listrik tenaga panas bumi adalah solusi energi bersih masa depan. Tanpa emisi karbon, tersedia 24/7, dan tidak bergantung cuaca. Indonesia memiliki 40% potensi panas bumi dunia - saatnya memanfaatkan energi dari perut bumi untuk masa depan berkelanjutan!"
                };
                
                return descriptions[scene.id] || scene.subtitle;
            },

            updateModels(scene) {
                this.elements.fullPlantModel.setAttribute('visible', false);
                this.elements.turbineFanModel.setAttribute('visible', false);
                
                if (scene.components && scene.components.length > 0) {
                    scene.components.forEach(component => {
                        if (component.name === 'full-geothermal-plant') {
                            this.elements.fullPlantModel.setAttribute('visible', true);
                            this.updateModelTransform(
                                this.elements.fullPlantModel,
                                component.position,
                                component.rotation,
                                component.scale
                            );
                        } else if (component.name === 'turbine-fan-animated') {
                            this.elements.turbineFanModel.setAttribute('visible', true);
                            this.updateModelTransform(
                                this.elements.turbineFanModel,
                                component.position,
                                component.rotation,
                                component.scale
                            );
                            
                            if (component.animation) {
                                this.applyAnimation(this.elements.turbineFanModel, component.animation);
                            }
                        }
                    });
                }
            },

            showCurrentSceneModels() {
                const scene = window.SCENE_CONFIG[this.state.currentSceneIndex];
                if (scene) {
                    this.updateModels(scene);
                }
            },

            updateModelTransform(model, position, rotation, scale) {
                if (position) model.setAttribute('position', position);
                if (rotation) model.setAttribute('rotation', rotation);
                if (scale) model.setAttribute('scale', scale);
            },

            applyAnimation(model, animationConfig) {
                if (animationConfig.type === 'rotation') {
                    const axis = animationConfig.axis || 'y';
                    const speed = animationConfig.speed || 1.0;
                    
                    model.removeAttribute('animation');
                    
                    model.setAttribute('animation', {
                        property: `rotation.${axis}`,
                        to: 360,
                        loop: true,
                        dur: (1000 / speed) * 360,
                        easing: 'linear'
                    });
                }
            },

            updateCamera(cameraConfig) {
                const camera = document.querySelector('a-camera');
                if (!camera || !cameraConfig.position) return;
                
                const duration = cameraConfig.duration || 2000;
                
                camera.setAttribute('animation', {
                    property: 'position',
                    to: cameraConfig.position,
                    dur: duration,
                    easing: 'easeInOutQuad'
                });
            },

            // ðŸ”§ FIX: Auto-play audio dengan proper error handling
            playAudio(audioPath) {
                if (!audioPath) {
                    console.warn('âš ï¸ No audio path provided');
                    return;
                }
                
                // Stop previous audio
                this.stopAudio();
                
                // Create new audio
                this.currentAudio = new Audio(audioPath);
                this.currentAudio.volume = 0.8;
                
                // Auto-play jika user sudah interact dan marker visible
                if (this.state.userInteracted && this.state.isMarkerVisible) {
                    this.elements.audioIndicator.classList.add('visible');
                    
                    this.currentAudio.play()
                        .then(() => {
                            console.log('ðŸ”Š Audio playing:', audioPath);
                            this.state.audioPlaying = true;
                        })
                        .catch(error => {
                            console.error('âŒ Audio playback failed:', error);
                            this.elements.audioIndicator.classList.remove('visible');
                        });
                    
                    this.currentAudio.addEventListener('ended', () => {
                        this.elements.audioIndicator.classList.remove('visible');
                        this.state.audioPlaying = false;
                    });
                }
            },

            stopAudio() {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                    this.currentAudio = null;
                    this.state.audioPlaying = false;
                    this.elements.audioIndicator.classList.remove('visible');
                }
            },

            nextScene() {
                const nextIndex = this.state.currentSceneIndex + 1;
                if (nextIndex < this.state.totalScenes) {
                    this.loadScene(nextIndex);
                }
            },

            previousScene() {
                const prevIndex = this.state.currentSceneIndex - 1;
                if (prevIndex >= 0) {
                    this.loadScene(prevIndex);
                }
            },

            updateNavButtons() {
                this.elements.btnPrev.disabled = this.state.currentSceneIndex === 0;
                this.elements.btnNext.disabled = this.state.currentSceneIndex === this.state.totalScenes - 1;
            },

            hideLoading() {
                this.elements.loadingScreen.classList.add('hidden');
            },

            showScannerInstructions() {
                this.elements.scannerInstructions.classList.add('visible');
                this.elements.statusBar.classList.add('visible');
            }
        };

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => ARController.init(), 500);
        });
    </script>
</body>
</html>